<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Segment Road Distance Within Radius</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: "Fira Sans", Arial, sans-serif;
  }

  #map { height: 92vh; }

  .segment-label {
    padding: 2px 4px;
    font-size: 12px;
  }

  .leaflet-routing-container {
    display: none !important;
  }

  .row { margin-bottom: 4px; }

  button {
    margin-right: 6px;
    padding: 4px 8px;
    font-size: 0.95em;
  }

  .calc-input {
    width: 50px;
    padding: 2px 4px;
    font-size: 0.85em;
    border: 1px solid #aaa;
    border-radius: 4px;
    margin-left: 3px;
    margin-right: 12px;
  }

  .input-label {
    font-size: 0.85em;
    color: #222;
    margin-left: 3px;
    margin-right: 2px;
  }

  .flex-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 4px;
  }

  /* --- basemap square buttons --- */
  #basemapButtons {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 9999;
    display: flex;
    gap: 6px;
  }

  .basemap-btn {
    width: 42px;
    height: 42px;
    border-radius: 6px;
    border: 2px solid #333;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    user-select: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }

  .basemap-btn.active {
    background: #dce7ff;
    border-color: #1f4fe0;
  }
</style>
</head>

<body>

<div id="controls">

  <div class="row flex-row">
    <span class="input-label">Calculate Total Road Distance</span>
    <button id="clear">Clear</button>
    <button id="exportPdf" style="display:none;">Export to PDF</button>
  </div>

  <div class="row flex-row">
    <button id="calc">Calc Road Base</button>

    <span class="input-label">Width(ft):</span>
    <input type="number" class="calc-input" id="widthFeet" value="15">

    <span class="input-label">Depth(in):</span>
    <input type="number" class="calc-input" id="depthInches" value="4">

    <span class="input-label">20 CY Cost($):</span>
    <input type="number" class="calc-input" id="costPerLoad" value="600">
  </div>
</div>

<!-- Road base calculator -->
<!-- Total distance box -->

<!-- Basemap buttons with icons + tooltips -->
<div id="basemapButtons">
  <div id="btnStreet" class="basemap-btn active" title="Street view">üõ£Ô∏è</div>
  <div id="btnTopo" class="basemap-btn" title="Terrain view">‚õ∞Ô∏è</div>
  <div id="btnSat" class="basemap-btn" title="Satellite view">üõ∞Ô∏è</div>
</div>

<div id="map">
<!-- Road base calculator -->
<div id="results" style="
  position:absolute;
  top:10px;
  left:60px;
  background:white;
  border:2px solid #333;
  padding:8px;
  display:none;
  z-index:9999;">
</div>

<!-- Total distance box -->
<div id="totalDistanceBox" style="
  position:absolute;
  top:10px;
  left:226px;
  background:white;
  border:2px solid #333;
  padding:8px;
  display:none;
  z-index:9999;
  font-weight:bold;">
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


<script>
// ---- fixed center ----
const center = L.latLng(37.647864, -105.564094);

// ---- map ----
const map = L.map('map').setView(center, 14);

// ---- basemap layers ----
const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap contributors'
});

const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  maxZoom: 17,
  attribution: '¬© OpenTopoMap contributors'
});

const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {
    maxZoom: 19,
    attribution: 'Tiles ¬© Esri'
  }
);

// default
let currentBase = street.addTo(map);

// ---- basemap toggle UI ----
function activateButton(activeId) {
  document.querySelectorAll('.basemap-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(activeId).classList.add('active');
}

document.getElementById("btnStreet").onclick = () => {
  map.removeLayer(currentBase);
  currentBase = street.addTo(map);
  activateButton("btnStreet");
};

document.getElementById("btnTopo").onclick = () => {
  map.removeLayer(currentBase);
  currentBase = topo.addTo(map);
  activateButton("btnTopo");
};

document.getElementById("btnSat").onclick = () => {
  map.removeLayer(currentBase);
  currentBase = satellite.addTo(map);
  activateButton("btnSat");
};

// ---- radius circle ----
const RADIUS_METERS = 1.5 * 1609.34;

L.circle(center, {
  radius: RADIUS_METERS,
  color: 'blue',
  fillOpacity: 0.01
}).addTo(map);

let originalBounds = map.getBounds();

// ---- state ----
let points = [];
let markers = [];
let routingControls = [];
let labels = [];
let totalMeters = 0;

// ---- helpers ----
function withinRadius(latlng) {
  return center.distanceTo(latlng) <= RADIUS_METERS;
}

function updateTotalBox() {
  const totalMiles = (totalMeters / 1609.34).toFixed(2);
  const box = document.getElementById("totalDistanceBox");
  box.style.display = "block";
  box.innerHTML = `Total Distance: ${totalMiles} mi`;
}

// ---- add segment ----
function addSegmentIfNeeded() {
  if (points.length < 2) return;

  const i = points.length - 2;

  const rc = L.Routing.control({
    waypoints: [points[i], points[i+1]],
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1'
    }),
    addWaypoints: false,
    draggableWaypoints: false,
    fitSelectedRoutes: false,
    showAlternatives: false,
    createMarker: () => null
  })
  .on('routesfound', function(event) {

    const route = event.routes[0];
    const meters = route.summary.totalDistance;

    totalMeters += meters;

    const miles = (meters / 1609.34).toFixed(2);

    const coords = route.coordinates;
    const mid = coords[Math.floor(coords.length / 2)];

    const label = L.marker([mid.lat, mid.lng], {
      icon: L.divIcon({
        className: 'segment-label',
        html: miles + " mi"
      })
    }).addTo(map);

    labels.push(label);

    updateTotalBox();
  })
  .addTo(map);

  routingControls.push(rc);
}

// ---- map click ----
map.on('click', function(e) {
  if (!withinRadius(e.latlng)) {
    alert("That point is outside the 1.5 mile radius.");
    return;
  }

  points.push(e.latlng);

  const m = L.marker(e.latlng).addTo(map);
  markers.push(m);

  addSegmentIfNeeded();
});

// ---- finish button ----


// ---- clear button ----
document.getElementById("clear").onclick = function() {

  points = [];
  totalMeters = 0;

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  routingControls.forEach(rc => map.removeControl(rc));
  routingControls = [];

  labels.forEach(l => map.removeLayer(l));
  labels = [];

  map.fitBounds(originalBounds);

  document.getElementById("results").style.display = "none";
  document.getElementById("results").innerHTML = "";

  document.getElementById("exportPdf").style.display = "none";

  document.getElementById("totalDistanceBox").style.display = "none";
};

// ---- calculator button ----
document.getElementById("calc").onclick = function () {

  if (totalMeters === 0) {
    alert("Measure a route first so we know the distance.");
    return;
  }

  if (points.length >= 2) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  const miles = totalMeters / 1609.34;

  const widthFeet = parseFloat(document.getElementById("widthFeet").value) || 15;
  const depthInches = parseFloat(document.getElementById("depthInches").value) || 4;
  const costPerLoad = parseFloat(document.getElementById("costPerLoad").value) || 600;

  const lengthFeet = miles * 5280;
  const depthFeet = depthInches / 12;

  const cubicFeet = lengthFeet * widthFeet * depthFeet;
  const cubicYards = cubicFeet / 27;

  const loadsNeeded = cubicYards / 20;

  const totalCostRaw = loadsNeeded * costPerLoad;
  const totalCost = Math.ceil(totalCostRaw * 100) / 100;

  const panel = document.getElementById("results");
  panel.style.display = "block";

  panel.innerHTML = `
    <b>Road-Base Calculator</b><br>
    Distance: ${miles.toFixed(2)} mi<br>
    Width: ${widthFeet} ft<br>
    Depth: ${depthInches} in<br>
    <hr>
    Volume: ${cubicYards.toFixed(0)} cubic yards<br>
    Loads (20 CY): ${loadsNeeded.toFixed(1)}<br>
    Cost per load: $${costPerLoad.toFixed(0)}<br>
    <b>Total Cost: $${totalCost.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</b>
  `;

  document.getElementById("exportPdf").style.display = "inline-block";
};

// ---- export to PDF ----
document.getElementById("exportPdf").onclick = async function () {

  if (totalMeters === 0) {
    alert("Nothing to export! Measure some segments first.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

// --- 1) Grab map as it appears on screen ---
const mapElement = document.getElementById("map");

// temporarily show controls if they were hidden
const resultsDiv = document.getElementById("results");
const totalDiv = document.getElementById("totalDistanceBox");




// --- Force Leaflet to redraw map and all polylines ---
map.invalidateSize(); // recalc map size & tiles

// --- 1) Temporarily hide routing lines ---
routingControls.forEach(rc => {
    const routes = rc.getRouter() ? rc._routes : []; // fallback if needed
    if (rc._line) map.removeLayer(rc._line); // removes the polyline from map
});

// Small delay to ensure map redraws without lines
await new Promise(resolve => setTimeout(resolve, 50));

// --- 2) Take html2canvas snapshot ---
const canvas = await html2canvas(mapElement, {
    useCORS: true,
    logging: false,
    scale: 2
});
const imgData = canvas.toDataURL("image/png");

// --- 3) Restore routing lines after snapshot ---
routingControls.forEach(rc => rc.addTo(map));







  // Fit screenshot into PDF width
  const pdfWidth = doc.internal.pageSize.getWidth();
  const imgProps = doc.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  const now = new Date();
  const formattedDateTime = now.toLocaleString(); // e.g., "1/4/2026, 8:15:30 PM"

  doc.setFontSize(14);
  doc.text(`Road Segment Report - ${formattedDateTime}`, 20, 12);

  // place image below title
  doc.addImage(imgData, "PNG", 10, 16, pdfWidth - 20, pdfHeight - 10);

  let y = pdfHeight + 20;

  // --- 2) Add total distance summary ---
  const miles = (totalMeters / 1609.34).toFixed(2);
  doc.setFontSize(12);
  doc.text(`Total Distance: ${miles} mi`, 20, y);
  y += 8;

  // --- 3) Add segment breakdown ---
  labels.forEach((label, i) => {
    const text = label._icon.innerText;
    doc.text(`Segment ${i + 1}: ${text}`, 20, y);
    y += 6;
  });

  y += 6;

  // --- 4) Add calculator results if visible ---
  if (resultsDiv.style.display !== "none") {

    doc.text("Road Base Calculator:", 20, y);
    y += 6;

    resultsDiv.innerText.split("\n").forEach(line => {
      if (y > 280) { // basic page break
        doc.addPage();
        y = 20;
      }
      doc.text(line, 25, y);
      y += 6;
    });
  }

  // --- Save PDF ---
  doc.save("RoadSegments.pdf");
};
</script>

</body>
</html>
