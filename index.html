<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Segment Road Distance Within Radius</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: "Fira Sans", Arial, sans-serif;
  }

  #map { height: 92vh; }

  .segment-label {
    padding: 2px 2px;
    font-size: 14px;
	line-height: 0.8;
	font-weight:bold;
	color: rgba(25, 25, 112, 0.9);
  }

  .leaflet-routing-container {
    display: none !important;
  }

  .row { margin-bottom: 4px; }

  button {
    margin-right: 4px;
    padding: 4px 6px;
    font-size: 0.90em;
	box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }
  
  .parcel-Button {
	background-color: white;
	border-radius: 5px; /* Rounded corners */
	border: 1px solid #555555;
    margin-right: 4px;
    padding: 5px 8px;
    font-size: 0.90em;
	box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }
  .parcel-Button:hover {
	background-color: #04AA6D;color: white;
  }

  .calc-input {
    width: 50px;
    padding: 2px 4px;
    font-size: 0.85em;
    border: 1px solid #aaa;
    border-radius: 4px;
    margin-left: 2px;
    margin-right: 6px;
  }

  .input-label {
    font-size: 0.85em;
    color: #222;
    margin-left: 3px;
    margin-right: 2px;
  }
  
  .zapata-label {
    font-size: 1.20em;
    color: #222;
    margin-left: 3px;
    margin-right: 2px;
	font-weight:bold;
  }

  .flex-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 4px;
  }

  /* --- basemap square buttons --- */
  #basemapButtons {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 9999;
    display: flex;
    gap: 6px;
  }

  .basemap-btn {
    width: 42px;
    height: 42px;
    border-radius: 6px;
    border: 2px solid #333;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    user-select: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }

  .basemap-btn.active {
    background: #dce7ff;
    border-color: #1f4fe0;
  }
  
  .north-arrow {
  background: white;
  border:2px solid #333;
  border-radius: 6px;
  opacity:0.9;
  padding: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  font-family: "Fira Sans", sans-serif;
  text-align: center;
  font-size: 12px;
  }

  .weather-box {
    background:white;
	border:2px solid #333;
    padding:10px 12px;
    border-radius:6px;
	opacity:0.9;
    box-shadow:0 2px 6px rgba(0,0,0,0.25);
    font-family:"Fira Sans", sans-serif;
    font-size:0.9em;
  }

  .wind-arrow {
    display: inline-block;
    transition: transform 0.3s ease;
    font-size: 10px;
    margin-right: 6px;
  }

</style>
</head>

<body>

<div id="controls">

  <div class="row flex-row">
    <span class="zapata-label">Zapata Road Segment Calculator</span>
    <button id="clear">Clear</button>
    <button id="undo" style="display:none;">Undo Marker</button>
    <button id="exportPdf" style="display:none;">Export PDF</button>
	<button class="parcel-Button" id="parcelBtn">Parcel View</button>
  </div>

  <div class="row flex-row">
    <button id="calc">Calculate Road Base</button>

    <span class="input-label">Width(ft):</span>
    <input type="number" class="calc-input" id="widthFeet" value="15">

    <span class="input-label">Depth(in):</span>
    <input type="number" class="calc-input" id="depthInches" value="4">

    <span class="input-label">20 CY Cost($):</span>
    <input type="number" class="calc-input" id="costPerLoad" value="600">
  </div>
</div>

<!-- Road base calculator -->
<!-- Total distance box -->

<!-- Basemap buttons with icons + tooltips -->
<div id="basemapButtons">
  <div id="btnStreet" class="basemap-btn active" title="Street view">üõ£Ô∏è</div>
  <div id="btnTopo" class="basemap-btn" title="Terrain view">‚õ∞Ô∏è</div>
  <div id="btnSat" class="basemap-btn" title="Satellite view">üõ∞Ô∏è</div>
</div>

<div id="map">
<!-- Road base calculator -->
<div id="results" style="
  position:absolute;
  top:10px;
  left:60px;
  background:white;
  border:2px solid #333;
  border-radius: 6px;
  opacity:0.9;
  padding:8px;
  display:none;
  z-index:9999;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);">
</div>

<!-- Total distance box -->
<div id="totalDistanceBox" style="
  position:absolute;
  top:10px;
  left:226px;
  background:white;
  border:2px solid #333;
  border-radius: 6px;
  opacity:0.9;
  padding:8px;
  display:none;
  z-index:9999;
  font-weight:bold;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);">
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


<script>
// ---- fixed center ----
const center = L.latLng(37.644310, -105.560972);

// ---- marker size ----

// ---- map ----
const map = L.map('map', {
  preferCanvas: true,
  disable3D: true,
  renderer: L.canvas()
}).setView(center, 14);

// ---- basemap layers ----
const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap contributors'
});

const topo = L.tileLayer(
'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}',
  {
    maxZoom: 19,
    attribution: "USGS Topographic Map"
  }
);

const satellite = L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {
    maxZoom: 19,
    attribution: 'Tiles ¬© Esri'
  }
);

// default and polyreplicate
let currentBase = street.addTo(map);
let customPolylines = [];

// scale
L.control.scale({
  position: 'bottomright',
  imperial: true,
  metric: false
}).addTo(map);

// north arrow
const northControl = L.control({ position: 'bottomright' });

northControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'north-arrow');
  div.innerHTML = `
    <div style="font-size:20px;">‚¨Ü</div>
    <div>North</div>
  `;
  return div;
};

northControl.addTo(map);

// weather control
const weatherControl = L.control({ position: 'topright' });

weatherControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'weather-box');
  div.id = "weatherBox";
  div.innerHTML = "Loading weather‚Ä¶";
  return div;
};

weatherControl.addTo(map);

// weather helper
function degreesToCardinal(deg) {
  if (deg == null) return "";
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S",
                "SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(deg / 22.5) % 16];
}

function formatTime(timestamp) {
  const d = new Date(timestamp);
  return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
}


// weather loader
async function loadWeatherAndAir() {
  const lat = center.lat;
  const lon = center.lng;

  try {
    //
    // ---- Fetch weather.gov observation ----
    //
    const meta = await fetch(`https://api.weather.gov/points/${lat},${lon}`).then(r => r.json());
    const stationsUrl = meta.properties.observationStations;

    const stations = await fetch(stationsUrl).then(r => r.json());
    const station = stations.features[0].properties.stationIdentifier;

    const obs = await fetch(`https://api.weather.gov/stations/${station}/observations/latest`).then(r => r.json());
    const p = obs.properties;

    const tempF = p.temperature.value != null ? (p.temperature.value * 9 / 5 + 32).toFixed(1) : "--";
    const windMph = p.windSpeed.value != null ? (p.windSpeed.value * 0.621371).toFixed(1) : "0";
    const humidity = p.relativeHumidity.value != null ? p.relativeHumidity.value.toFixed(0) : "--";

    const windDirDeg = p.windDirection.value;
    const windDirText = degreesToCardinal(windDirDeg);
    const desc = p.textDescription || "Clear";

    const isNight =
      desc.includes("Night") ||
      (new Date().getHours() >= 18 || new Date().getHours() <= 5);

    const iconChar =
      desc.includes("Snow") ? "‚ùÑÔ∏è" :
      desc.includes("Rain") ? "üåßÔ∏è" :
      desc.includes("Cloud") ? "‚òÅÔ∏è" :
      isNight ? "üåô" : "‚òÄÔ∏è";

    const updated = formatTime(p.timestamp);

    //
    // ---- Fetch Air Quality (AirNow) ----
    //
    let aqiDisplay = "N/A";
    let aqiCategory = "Unavailable";

    try {
      const apiKey = "F4A5C12E-F2F6-4F67-B5F3-EEC27F4FC235";
      const aqiUrl = `https://www.airnowapi.org/aq/observation/latLong/current?format=application/json&latitude=${lat}&longitude=${lon}&distance=25&API_KEY=${apiKey}`;

      const resp = await fetch(aqiUrl);
      const data = await resp.json();

      if (data && data.length > 0) {
        const aqiInfo = data[0];
        aqiDisplay = aqiInfo.AQI;
        aqiCategory = aqiInfo.Category?.Name || "Unknown";
      }
    } catch (err) {
      console.error("AirNow error:", err);
    }

    //
    // ---- Render unified panel ----
    //
    document.getElementById("weatherBox").innerHTML = `
      <b>Current Conditions</b><br>

      <span style="font-size:0.8em;color:#444;">
        Updated ${updated}
      </span><br>

      <span title="${desc}">
        ${iconChar}
      </span> ${desc}<br>

      <span title="Air Temperature">
        üå°Ô∏è
      </span> ${tempF} ¬∞F<br>

      <span title="Relative Humidity">
        üíß
      </span> Humidity: ${humidity}%<br>

      <span
        class="wind-arrow"
        title="Wind direction and speed"
        style="transform: rotate(${windDirDeg}deg);"
      >ü°±</span>
      ${windMph} mph ${windDirText}<br>

      <span title="Air Quality Index and category">
        üå∑ AQI: ${aqiDisplay} (${aqiCategory})
      </span>
    `;
  }

  catch (err) {
    console.error(err);
    document.getElementById("weatherBox").innerHTML = `
      <b>Weather Unavailable</b><br>
      Unable to retrieve data at this moment.
    `;
  }
}

// initial + interval refresh
loadWeatherAndAir();
setInterval(loadWeatherAndAir, 10 * 60 * 1000);


// ---- parcel link ----
document.getElementById("parcelBtn").addEventListener("click", function () {
  // Replace this with your tuned parcel link when ready
  const parcelUrl = "https://qpublic.schneidercorp.com/Application.aspx?AppID=1223&LayerID=37300&PageTypeID=1&PageID=14256&KeyValue=514509108001";

  window.open(parcelUrl, "_blank");
});

// ---- hillshade relief ----

// ---- contours ----
const usgscontours = L.tileLayer(
  "https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}",
  { opacity: 1.0 }
);


// ---- basemap toggle UI ----
function activateButton(activeId) {
  document.querySelectorAll('.basemap-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(activeId).classList.add('active');
}

document.getElementById("btnStreet").onclick = () => {
  map.removeLayer(currentBase);
  currentBase = street.addTo(map);
  activateButton("btnStreet");
};

document.getElementById("btnTopo").onclick = () => {
  map.removeLayer(currentBase);
  currentBase = topo.addTo(map);
  activateButton("btnTopo");
};

document.getElementById("btnSat").onclick = () => {
  map.removeLayer(currentBase);
  currentBase = satellite.addTo(map);
  activateButton("btnSat");
};

// ---- radius circle ----
const RADIUS_METERS = 2.0 * 1609.34;

const radiusCircle = L.circle(center, {
  radius: RADIUS_METERS,
  color: 'blue',
  fillOpacity: 0.01
}).addTo(map);

let originalBounds = map.getBounds();

// ---- state ----
let points = [];
let markers = [];
let routingControls = [];
let labels = [];
let totalMeters = 0;
let segmentMeters = [];


// ---- helpers ----
function withinRadius(latlng) {
  return center.distanceTo(latlng) <= RADIUS_METERS;
}

function updateTotalBox() {
  const totalMiles = (totalMeters / 1609.34).toFixed(2);
  const box = document.getElementById("totalDistanceBox");
  box.style.display = "block";
  box.innerHTML = `Total Distance: ${totalMiles} mi`;
}

// ---- add segment ----
function addSegmentIfNeeded() {
  
  if (points.length < 2) return;

  const i = points.length - 2;

  const rc = L.Routing.control({
    waypoints: [points[i], points[i+1]],
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1'
    }),
    addWaypoints: false,
    draggableWaypoints: false,
    fitSelectedRoutes: false,
    showAlternatives: false,

    createMarker: () => null,

    // üî¥ turn OFF default routing-machine line
    routeLine: function () {
      return L.layerGroup();   // returns empty layer group (no polyline)
    },
  })
  
  .on('routesfound', function(event) {

    const route = event.routes[0];
    const meters = route.summary.totalDistance;
	segmentMeters.push(meters);
	
    totalMeters += meters;

    const miles = (meters / 1609.34).toFixed(2);

    const coords = route.coordinates;
	// convert to Leaflet lat/lng array
	const latLngs = coords.map(c => [c.lat, c.lng]);
	// draw our OWN printable SVG polyline
	const poly = L.polyline(latLngs, {
		color: 'yellow',
		weight: 12,
		opacity: 0.5
		}).addTo(map);
	// store for later removal/toggling
	customPolylines.push(poly);

    const mid = coords[Math.floor(coords.length / 2)];

    const label = L.marker([mid.lat, mid.lng], {
      icon: L.divIcon({
        className: 'segment-label',
        html: miles + " mile"
      })
    }).addTo(map);

    labels.push(label);

    updateTotalBox();
  })
  .addTo(map);

  routingControls.push(rc);
  document.getElementById("undo").style.display = "inline-block";
}

// ---- map click ----
map.on('click', function(e) {
  if (!withinRadius(e.latlng)) {
    alert("That point is outside the 1.5 mile radius.");
    return;
  }

  points.push(e.latlng);

  const m = L.marker(e.latlng).addTo(map);
  markers.push(m);

  addSegmentIfNeeded();
});

// ---- undo logic ----
document.getElementById("undo").onclick = function () {

  if (points.length === 0) return;

  // remove last point
  points.pop();

  // remove last marker
  const m = markers.pop();
  if (m) map.removeLayer(m);

  // remove last routing control
  const rc = routingControls.pop();
  if (rc) map.removeControl(rc);

  // remove last custom polyline
  const pl = customPolylines.pop();
  if (pl) map.removeLayer(pl);

  // remove last label
  const lab = labels.pop();
  if (lab) map.removeLayer(lab);

  // adjust total distance
  const seg = segmentMeters.pop();
  if (seg) totalMeters -= seg;

  if (totalMeters < 0) totalMeters = 0;

  if (points.length < 2) {
    document.getElementById("totalDistanceBox").style.display = "none";
  } else {
    updateTotalBox();
  }
};




// ---- clear button ----
document.getElementById("clear").onclick = function() {

  points = [];
  totalMeters = 0;

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  routingControls.forEach(rc => map.removeControl(rc));
  routingControls = [];

	customPolylines.forEach(p => map.removeLayer(p));
	customPolylines = [];
	
  labels.forEach(l => map.removeLayer(l));
  labels = [];

  map.fitBounds(originalBounds);

  document.getElementById("results").style.display = "none";
  document.getElementById("results").innerHTML = "";
  document.getElementById("exportPdf").style.display = "none";
  document.getElementById("undo").style.display = "none";
  document.getElementById("totalDistanceBox").style.display = "none";
  


};

// ---- calculator button ----
document.getElementById("calc").onclick = function () {

  if (totalMeters === 0) {
    alert("Measure a route first so we know the distance.");
    return;
  }

  if (points.length >= 2) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  const miles = totalMeters / 1609.34;

  const widthFeet = parseFloat(document.getElementById("widthFeet").value) || 15;
  const depthInches = parseFloat(document.getElementById("depthInches").value) || 4;
  const costPerLoad = parseFloat(document.getElementById("costPerLoad").value) || 600;

  const lengthFeet = miles * 5280;
  const depthFeet = depthInches / 12;

  const cubicFeet = lengthFeet * widthFeet * depthFeet;
  const cubicYards = cubicFeet / 27;

  const loadsNeeded = cubicYards / 20;

  const totalCostRaw = loadsNeeded * costPerLoad;
  const totalCost = Math.ceil(totalCostRaw * 100) / 100;

  const panel = document.getElementById("results");
  panel.style.display = "block";

  panel.innerHTML = `
    <b>Road-Base Calculator</b><br>
    Distance: ${miles.toFixed(2)} mi<br>
    Width: ${widthFeet} ft<br>
    Depth: ${depthInches} in<br>
    <hr>
    Volume: ${cubicYards.toFixed(0)} cubic yards<br>
    Loads (20 CY): ${loadsNeeded.toFixed(1)}<br>
    Cost per load: $${costPerLoad.toFixed(0)}<br>
    <b>Total Cost: $${totalCost.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</b>
  `;

  document.getElementById("exportPdf").style.display = "inline-block";
};




// ---- export to PDF ----
document.getElementById("exportPdf").onclick = async function () {

  if (totalMeters === 0) {
    alert("Nothing to export! Measure some segments first.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

// --- Force Leaflet to redraw map and all polylines ---
map.invalidateSize(); // recalc map size & tiles

// --- 1) Grab map as it appears on screen ---
const mapElement = document.getElementById("map");
// temporarily show controls if they were hidden
const resultsDiv = document.getElementById("results");
const totalDiv = document.getElementById("totalDistanceBox");
const polyDiv = document.getElementById("poly");

// --- 1) Temporarily hide routing lines ---
//routingControls.forEach(rc => {
//    const routes = rc.getRouter() ? rc._routes : []; // fallback //if needed
//    if (rc._line) map.removeLayer(rc._line); // removes the //polyline from map
//});

// --- 1a) ALSO hide the blue circle ---
map.removeLayer(radiusCircle);

// Small delay to ensure map redraws without lines
await new Promise(resolve => setTimeout(resolve, 50));

// --- 1b) freeze CSS transforms ---
const panes = document.getElementsByClassName('leaflet-pane');
for (let p of panes) {
  p.style.transform = 'none';
}

// --- 1d) force leaflet to settle ---
// map.invalidateSize();
// map.once('idle', function () {
	// --- 2) Take html2canvas snapshot ---
	const canvas = await html2canvas(mapElement, {
		useCORS: true,
		logging: false,
		scale: 2
	});
	const imgData = canvas.toDataURL("image/png");
// });

// --- 3) Restore routing lines after snapshot ---
//routingControls.forEach(rc => rc.addTo(map));

// --- 3a) Restore circle ---
radiusCircle.addTo(map);

// --- 3b) Restore Leaflet Transform Animations ---
for (let p of panes) {
  p.style.transform = '';
}




  // Fit screenshot into PDF width
  const pdfWidth = doc.internal.pageSize.getWidth();
  const imgProps = doc.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  const now = new Date();
  const formattedDateTime = now.toLocaleString(); // e.g., "1/4/2026, 8:15:30 PM"

  doc.setFontSize(14);
  doc.text(`Zapata Road Segment Report - ${formattedDateTime}`, 20, 12);

  // place image below title
  doc.addImage(imgData, "PNG", 10, 16, pdfWidth - 20, pdfHeight - 10);

  let y = pdfHeight + 20;

  // --- 2) Add total distance summary ---
  const miles = (totalMeters / 1609.34).toFixed(2);
  doc.setFontSize(8);
  doc.text(`Total Distance: ${miles} mi`, 20, y);
  y += 4;

  // --- 3) Add segment breakdown ---
  labels.forEach((label, i) => {
    const text = label._icon.innerText;
    doc.text(`Segment ${i + 1}: ${text}`, 20, y);
    y += 4;
  });

  y += 4;

  // --- 4) Add calculator results if visible ---
  if (resultsDiv.style.display !== "none") {

    doc.text("Road Base Calculator:", 20, y);
    y += 4;

    resultsDiv.innerText.split("\n").forEach(line => {
      if (y > 280) { // basic page break
        doc.addPage();
        y = 20;
      }
      doc.text(line, 25, y);
      y += 4; //6
    });
  }

  // --- Save PDF ---
  doc.save("RoadSegments.pdf");
};
</script>

</body>
</html>
